<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barony Tracker - Final Sync</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        :root { --bg: #0f0a07; --panel: #261a12; --gold: #8c6a31; --text: #e0d0b8; --highlight: #f2c05e; --danger: #8a1313; }
        body { background: var(--bg); color: var(--text); font-family: 'VT323', monospace; padding: 15px; display: flex; justify-content: center; margin: 0; }
        .container { width: 100%; max-width: 900px; border: 4px solid var(--gold); background: var(--panel); box-shadow: 0 0 20px #000; }
        header { padding: 15px; border-bottom: 2px solid var(--gold); background: #1a120b; }
        .scroll-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); background: #000; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #33241a; }
        select { background: #000; color: var(--highlight); border: 2px solid var(--gold); font-family: 'VT323'; font-size: 1.1rem; width: 150px; outline:none; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; background: #555; }
        .online { background: #4CAF50; box-shadow: 0 0 8px #4CAF50; }
        #error-log { background: var(--danger); color: #fff; padding: 5px; display: none; text-align: center; }
        #nameOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #nameOverlay.show { display: flex; }
        button { background: #3d2b1f; color: #fff; border: 2px solid var(--gold); cursor: pointer; font-family: 'VT323'; padding: 5px 15px; }
    </style>
</head>
<body>
    <div id="nameOverlay">
        <h2 style="color:var(--gold)">WHO ART THOU?</h2>
        <input type="text" id="nIn" style="background:#000; color:#fff; border:2px solid var(--gold); font-family:'VT323'; font-size: 1.5rem; text-align: center;">
        <button onclick="saveName()" style="margin-top:20px;">ENTER DUNGEON</button>
    </div>

    <div class="container">
        <div id="error-log"></div>
        <header>
            <div style="display:flex; justify-content:space-between; align-items: center;">
                <h1 style="margin:0">ðŸ“œ BARONY SCROLLS</h1>
                <div id="counter" style="color: #4CAF50; font-size: 1.4rem;">0 / 24</div>
            </div>
            <div id="playerList" style="color:#8a7a6a; margin-top:5px;">In Dungeon: ...</div>
        </header>
        <div id="grid" class="scroll-grid"></div>
        <footer style="padding:15px; background:#1a120b; border-top: 2px solid var(--gold); display:flex; justify-content:space-between; align-items:center;">
            <div><span id="syncDot" class="status-dot"></span> <span id="roomLabel" style="color:#8a7a6a"></span></div>
            <button onclick="resetRoom()" style="color: #ff6666; border-color: #800;">Reset Run</button>
        </footer>
    </div>

    <script>
        const SUB_URL = "https://pvbeaaatyaunnlzybgsu.supabase.co"; 
        const SUB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2YmVhYWF0eWF1bm5senliZ3N1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NDM1NDQsImV4cCI6MjA4NjQxOTU0NH0.7YZAuLHZnv8Zm6d-2lmf8oHmQ7Ebw5dznF8ZwqdIDOY"; 
        const client = supabase.createClient(SUB_URL, SUB_KEY);

        const NAMES = ["Zelgo Mer", "Juyed Awk Yacc", "NR 9", "Nobary Robyan", "Pratyavayah", "Daiyen Fooels", "Lep Gex Ven Zea", "Prirutsenie", "Elbib Yloh", "Verr Yed Horre", "Venzar Borgavve", "Tharr", "Yum Yum", "Kernod Wel", "Elam Ebow", "Duam Xnaht", "Andova Begarin", "Kirje", "Hackem Muche", "Velox Neb", "Foobie Bletch", "Temov", "Garven Deh", "Read Me"];
        const EFFECTS = ["???", "Blank", "Fire", "Remove Curse", "Light", "Identify", "Repair", "Destroy Armor", "Magic Mapping", "Charging", "Conjure Arrow", "Food", "Teleportation", "Summon", "Enchant Weapon", "Enchant Armor", "Letter"];

        const urlParams = new URLSearchParams(window.location.search);
        let roomId = urlParams.get('room') || Math.random().toString(36).substring(2, 8);
        if (!urlParams.get('room')) history.replaceState(null, null, `?room=${roomId}`);
        document.getElementById('roomLabel').innerText = "Room: " + roomId;

        let charName = localStorage.getItem('barony_user');
        if(!charName) document.getElementById('nameOverlay').classList.add('show');

        function saveName() {
            const val = document.getElementById('nIn').value.trim();
            if(val) { localStorage.setItem('barony_user', val); location.reload(); }
        }

        function initGrid() {
            const grid = document.getElementById('grid');
            NAMES.forEach(name => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `<span>${name}</span><select id="s-${name.replace(/\s+/g,'')}"></select>`;
                grid.appendChild(div);
            });
        }

        async function syncData() {
            const { data, error } = await client.from('scrolls').select('*').eq('room_id', roomId);
            if(error) return;

            const current = {};
            let count = 0;
            data.forEach(r => { current[r.scroll_name] = r.effect; if(r.effect !== "???") count++; });

            const taken = Object.values(current).filter(v => v !== "???" && v !== "Letter");

            NAMES.forEach(name => {
                const sel = document.getElementById(`s-${name.replace(/\s+/g,'')}`);
                const val = current[name] || "???";
                sel.innerHTML = '';
                EFFECTS.forEach(e => {
                    if(e === "???" || e === "Letter" || e === val || !taken.includes(e)) {
                        const opt = document.createElement('option');
                        opt.value = opt.text = e;
                        sel.appendChild(opt);
                    }
                });
                sel.value = val;
                sel.style.borderColor = (val !== "???") ? "#4CAF50" : "var(--gold)";
                sel.onchange = async () => {
                    const { error } = await client.from('scrolls').upsert({ room_id: roomId, scroll_name: name, effect: sel.value });
                    if(error) { document.getElementById('error-log').innerText = error.message; document.getElementById('error-log').style.display = 'block'; }
                };
            });
            document.getElementById('counter').innerText = `Discovered: ${count} / 24`;
        }

        async function updatePlayers() {
            const { data } = await client.from('players').select('*').eq('room_id', roomId);
            if(data) {
                const now = new Date();
                const active = data.filter(p => (now - new Date(p.last_seen)) < 15000).map(p => p.name);
                document.getElementById('playerList').innerText = "In Dungeon: " + active.join(", ");
            }
        }

        async function resetRoom() {
            if(confirm("Wipe room?")) { await client.from('scrolls').delete().eq('room_id', roomId); syncData(); }
        }

        client.channel('realtime').on('postgres_changes', { event: '*', schema: 'public', table: 'scrolls' }, () => syncData())
            .on('postgres_changes', { event: '*', schema: 'public', table: 'players' }, () => updatePlayers())
            .subscribe(s => { if(s === 'SUBSCRIBED') document.getElementById('syncDot').classList.add('online'); });

        setInterval(async () => {
            if(charName) {
                await client.from('players').upsert({ room_id: roomId, name: charName, last_seen: new Date().toISOString() });
                updatePlayers();
            }
        }, 5000);

        initGrid();
        syncData();
    </script>
</body>
</html>
