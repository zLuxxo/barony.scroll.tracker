<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barony Live Tracker - Fixed</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        :root {
            --bg-color: #120d08;
            --panel-bg: #2e2016;
            --border-gold: #8c6a31;
            --text-main: #e0d0b8;
            --row-even: #261a12;
            --row-odd: #33241a;
            --highlight: #f2c05e;
            --danger: #9e1b1b;
            --success: #4CAF50;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'VT323', monospace;
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 950px;
            border: 4px solid var(--border-gold);
            background: var(--panel-bg);
            box-shadow: 0 0 30px rgba(0,0,0,0.7);
        }

        header {
            background: #1e150f;
            padding: 15px 20px;
            border-bottom: 4px solid var(--border-gold);
        }

        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .player-list { font-size: 1.1rem; color: #aaa; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 4px; min-height: 24px;}
        .player-tag { color: var(--highlight); margin-right: 10px; border-bottom: 1px solid var(--highlight); }

        .stats { color: var(--success); font-size: 1.4rem; }
        h1 { margin: 0; font-size: 2.2rem; color: var(--highlight); text-transform: uppercase; }

        .scroll-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            background: #1a120b;
        }

        .scroll-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border: 1px solid rgba(140, 106, 49, 0.1);
        }

        .scroll-item:nth-child(4n+1), .scroll-item:nth-child(4n+2) { background: var(--row-odd); }
        .scroll-item:nth-child(4n+3), .scroll-item:nth-child(4n+4) { background: var(--row-even); }

        select {
            background: #000;
            color: var(--highlight);
            border: 2px solid var(--border-gold);
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
            padding: 4px;
            width: 160px;
            cursor: pointer;
        }

        select.identified { border-color: var(--success); color: #fff; }

        .controls {
            padding: 15px;
            background: #1e150f;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
            border-top: 4px solid var(--border-gold);
        }

        .room-actions { display: flex; gap: 8px; align-items: center; }
        
        input {
            background: #000;
            border: 1px solid var(--border-gold);
            color: var(--highlight);
            font-family: 'VT323', monospace;
            padding: 5px;
            width: 80px;
        }

        button {
            background: #4a3828;
            color: #fff;
            border: 2px solid var(--border-gold);
            font-family: 'VT323', monospace;
            font-size: 1rem;
            padding: 5px 12px;
            cursor: pointer;
        }

        button.reset-btn { background: var(--danger); border-color: #ff4d4d; font-size: 1.2rem; padding: 8px 20px; }
        button:hover { filter: brightness(1.2); }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="header-top">
                <h1>ðŸ“œ Barony Scrolls</h1>
                <div class="stats" id="counter">Discovered: 0 / 24</div>
            </div>
            <div class="player-list" id="playerList">In Dungeon: </div>
        </header>

        <div id="scrollGrid" class="scroll-grid"></div>

        <div class="controls">
            <div class="room-actions">
                <span id="roomDisplay" style="color:#8a7a6a">Room: ...</span>
                <button onclick="copyRoomLink()">Copy Link</button>
                <input type="text" id="manualRoom" placeholder="ID">
                <button onclick="joinManualRoom()">Join</button>
            </div>
            <button class="reset-btn" onclick="resetRun()">RESET RUN</button>
        </div>
    </div>

    <script>
        const SCROLL_NAMES = ["Zelgo Mer", "Juyed Awk Yacc", "NR 9", "Nobary Robyan", "Pratyavayah", "Daiyen Fooels", "Lep Gex Ven Zea", "Prirutsenie", "Elbib Yloh", "Verr Yed Horre", "Venzar Borgavve", "Tharr", "Yum Yum", "Kernod Wel", "Elam Ebow", "Duam Xnaht", "Andova Begarin", "Kirje", "Hackem Muche", "Velox Neb", "Foobie Bletch", "Temov", "Garven Deh", "Read Me"];
        const ALL_EFFECTS = ["???", "Blank", "Fire", "Remove Curse", "Light", "Identify", "Repair", "Destroy Armor", "Magic Mapping", "Charging", "Conjure Arrow", "Food", "Teleportation", "Summon", "Enchant Weapon", "Enchant Armor", "Letter"];

        let currentSelections = {};
        let myName = localStorage.getItem('barony_name') || prompt("Enter Character Name:") || "Adventurer";
        localStorage.setItem('barony_name', myName);

        // FIX: Correctly parse Room ID from URL before doing anything else
        const urlParams = new URLSearchParams(window.location.search);
        let roomId = urlParams.get('room');
        
        if (!roomId) {
            roomId = Math.random().toString(36).substring(2, 8);
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + roomId;
            window.history.pushState({path:newUrl}, '', newUrl);
        }

        document.getElementById('roomDisplay').innerText = `Room: ${roomId}`;

        const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']).get('barony_final_v1').get(roomId);

        // Presence
        setInterval(() => gun.get('players').get(myName).put(Date.now()), 5000);
        gun.get('players').map().on((time, name) => {
            const list = document.getElementById('playerList');
            let el = document.getElementById(`p-${name}`);
            if (Date.now() - time < 15000) {
                if (!el) {
                    el = document.createElement('span');
                    el.id = `p-${name}`;
                    el.className = 'player-tag';
                    el.innerText = name;
                    list.appendChild(el);
                }
            } else if (el) { el.remove(); }
        });

        // Build UI once to prevent disappearing scrolls
        const grid = document.getElementById('scrollGrid');
        SCROLL_NAMES.forEach(name => {
            const item = document.createElement('div');
            item.className = 'scroll-item';
            item.innerHTML = `<span class="scroll-name">${name}</span><select id="sel-${name.replace(/\s+/g, '')}"></select>`;
            grid.appendChild(item);
            
            const sel = item.querySelector('select');
            // Default populate so they aren't empty
            ALL_EFFECTS.forEach(eff => {
                const opt = document.createElement('option');
                opt.value = opt.text = eff;
                sel.appendChild(opt);
            });

            sel.onchange = (e) => gun.get('scrolls').get(name).put(e.target.value);
            
            gun.get('scrolls').get(name).on((val) => {
                currentSelections[name] = val || "???";
                renderAllDropdowns();
            });
        });

        function renderAllDropdowns() {
            const usedEffects = Object.values(currentSelections).filter(v => v !== "???" && v !== "Letter");
            let disc = 0;

            SCROLL_NAMES.forEach(name => {
                const sel = document.getElementById(`sel-${name.replace(/\s+/g, '')}`);
                const currentVal = currentSelections[name] || "???";
                if (currentVal !== "???") disc++;

                // Efficiently update options without wiping the whole element
                Array.from(sel.options).forEach(opt => {
                    const eff = opt.value;
                    const isOtherUserUsing = usedEffects.includes(eff) && currentVal !== eff && eff !== "Letter" && eff !== "???";
                    opt.style.display = isOtherUserUsing ? "none" : "block";
                    opt.disabled = isOtherUserUsing;
                });
                
                sel.value = currentVal;
                sel.className = currentVal !== "???" ? 'identified' : '';
            });
            document.getElementById('counter').innerText = `Discovered: ${disc} / 24`;
        }

        function copyRoomLink() {
            navigator.clipboard.writeText(window.location.href);
            alert("Link copied! Send it to your party.");
        }

        function joinManualRoom() {
            const newId = document.getElementById('manualRoom').value.trim();
            if(newId) window.location.search = `?room=${newId}`;
        }

        function resetRun() {
            if(confirm("Wipe all scrolls?")) {
                SCROLL_NAMES.forEach(n => gun.get('scrolls').get(n).put("???"));
            }
        }
    </script>
</body>
</html>
